{
  "enabled": true,
  "name": "Issue Auto Closer",
  "description": "Cierra automÃ¡ticamente GitHub Issues cuando se resuelven los problemas",
  "version": "1.0",
  "when": {
    "type": "onCommit"
  },
  "then": {
    "type": "askAgent",
    "prompt": "ğŸ”„ **Issue Auto Closer**\n\nVoy a analizar el commit reciente y cerrar automÃ¡ticamente los issues relacionados.\n\n## ğŸ“Š **AnÃ¡lisis del Commit:**\n\n### **1. Detectar Issues Mencionados**\n```bash\necho \"ğŸ” Analizando commit para issues relacionados...\"\n\n# Obtener mensaje del Ãºltimo commit\nCOMMIT_MSG=$(git log -1 --pretty=%B)\necho \"ğŸ“ Mensaje del commit: $COMMIT_MSG\"\n\n# Buscar referencias a issues\nISSUE_REFS=$(echo \"$COMMIT_MSG\" | grep -oE \"#[0-9]+|[Ff]ixes #[0-9]+|[Cc]loses #[0-9]+|[Rr]esolves #[0-9]+\")\necho \"ğŸ”— Issues referenciados: $ISSUE_REFS\"\n```\n\n### **2. Verificar Estado de Tests**\n```bash\necho \"ğŸ§ª Verificando si los tests ahora pasan...\"\n\n# Ejecutar tests para verificar si se arreglaron\ncd Req/backend\nTEST_RESULT=$(npm run test --silent 2>&1)\nTEST_EXIT_CODE=$?\n\nif [ $TEST_EXIT_CODE -eq 0 ]; then\n    echo \"âœ… Tests pasando - Issues de bugs pueden cerrarse\"\n    TESTS_PASSING=true\nelse\n    echo \"âŒ Tests aÃºn fallando - Mantener issues abiertos\"\n    TESTS_PASSING=false\nfi\n```\n\n### **3. Analizar Archivos Modificados**\n```bash\necho \"ğŸ“ Analizando archivos modificados...\"\n\n# Obtener archivos modificados en el commit\nMODIFIED_FILES=$(git diff-tree --no-commit-id --name-only -r HEAD)\necho \"ğŸ“„ Archivos modificados:\"\necho \"$MODIFIED_FILES\"\n\n# Categorizar cambios\nif echo \"$MODIFIED_FILES\" | grep -q \"\\.test\\.ts\"; then\n    echo \"ğŸ§ª Tests modificados\"\n    TESTS_MODIFIED=true\nfi\n\nif echo \"$MODIFIED_FILES\" | grep -q \"src/services\"; then\n    echo \"ğŸ”§ Servicios modificados\"\n    SERVICES_MODIFIED=true\nfi\n\nif echo \"$MODIFIED_FILES\" | grep -q \"package\\.json\"; then\n    echo \"ğŸ“¦ Dependencias modificadas\"\n    DEPS_MODIFIED=true\nfi\n```\n\n## ğŸ¯ **Cierre AutomÃ¡tico de Issues:**\n\n### **Estrategia 1: Cierre por Palabras Clave**\n```bash\n# Si el commit menciona explÃ­citamente cerrar issues\nif echo \"$COMMIT_MSG\" | grep -qiE \"fixes|closes|resolves\"; then\n    echo \"ğŸ¯ Commit indica cierre explÃ­cito de issues\"\n    \n    # Extraer nÃºmeros de issues\n    ISSUE_NUMBERS=$(echo \"$COMMIT_MSG\" | grep -oE \"#[0-9]+\" | sed 's/#//')\n    \n    for issue_num in $ISSUE_NUMBERS; do\n        echo \"ğŸ”’ Cerrando issue #$issue_num automÃ¡ticamente\"\n        gh issue close $issue_num --comment \"âœ… Resuelto en commit $(git rev-parse --short HEAD)\n        \n**Cambios realizados:**\n$(echo \"$COMMIT_MSG\" | head -1)\n\n**Archivos modificados:**\n$(echo \"$MODIFIED_FILES\" | sed 's/^/- /')\n\n**Tests:** $([ \"$TESTS_PASSING\" = true ] && echo \"âœ… Pasando\" || echo \"âŒ AÃºn fallando\")\n\n*Cerrado automÃ¡ticamente por Issue Auto Closer*\"\n    done\nfi\n```\n\n### **Estrategia 2: Cierre Inteligente por Contexto**\n```bash\n# Buscar issues abiertos relacionados con archivos modificados\necho \"ğŸ¤– Buscando issues relacionados con archivos modificados...\"\n\n# Obtener issues abiertos\nOPEN_ISSUES=$(gh issue list --state open --json number,title,body)\n\n# Para cada archivo modificado, buscar issues relacionados\nfor file in $MODIFIED_FILES; do\n    echo \"ğŸ“„ Buscando issues relacionados con: $file\"\n    \n    # Buscar issues que mencionen este archivo\n    RELATED_ISSUES=$(echo \"$OPEN_ISSUES\" | jq -r \".[] | select(.body | contains(\\\"$file\\\")) | .number\")\n    \n    for issue_num in $RELATED_ISSUES; do\n        if [ \"$TESTS_PASSING\" = true ]; then\n            echo \"ğŸ¯ Issue #$issue_num parece resuelto (tests pasando + archivo modificado)\"\n            \n            # Preguntar antes de cerrar automÃ¡ticamente\n            gh issue comment $issue_num --body \"ğŸ¤– **Auto-detection**: Este issue parece estar resuelto.\n            \n**Evidencia:**\n- âœ… Tests ahora pasan\n- ğŸ“„ Archivo relacionado modificado: \\`$file\\`\n- ğŸ“ Commit: $(git log -1 --oneline)\n\nÂ¿DeberÃ­a cerrarse automÃ¡ticamente este issue?\"\n        fi\n    done\ndone\n```\n\n### **Estrategia 3: Cierre por ResoluciÃ³n de Tests**\n```bash\n# Si habÃ­a issues de tests y ahora pasan\nif [ \"$TESTS_PASSING\" = true ] && [ \"$TESTS_MODIFIED\" = true ]; then\n    echo \"ğŸ§ª Tests modificados y ahora pasan - Buscando issues de bugs\"\n    \n    # Buscar issues con label 'bug' que estÃ©n abiertos\n    BUG_ISSUES=$(gh issue list --label \"bug\" --state open --json number,title)\n    \n    if [ -n \"$BUG_ISSUES\" ]; then\n        echo \"ğŸ› Encontrados issues de bugs abiertos:\"\n        echo \"$BUG_ISSUES\" | jq -r '.[] | \"#\\(.number): \\(.title)\"'\n        \n        # Comentar en issues de bugs que los tests ahora pasan\n        echo \"$BUG_ISSUES\" | jq -r '.[] | .number' | while read issue_num; do\n            gh issue comment $issue_num --body \"ğŸ§ª **Test Status Update**: Los tests ahora estÃ¡n pasando despuÃ©s del commit $(git rev-parse --short HEAD).\n            \n**Cambios en este commit:**\n$(echo \"$COMMIT_MSG\" | head -1)\n\n**Archivos de tests modificados:**\n$(echo \"$MODIFIED_FILES\" | grep \"\\.test\\.ts\" | sed 's/^/- /' || echo \"- Ninguno\")\n\nÂ¿Este commit resuelve el issue? Si es asÃ­, puede cerrarse.\"\n        done\n    fi\nfi\n```\n\n## ğŸ“Š **Reglas de Cierre AutomÃ¡tico:**\n\n### **Cierre Inmediato (AutomÃ¡tico):**\n- âœ… Commit con \"Fixes #123\", \"Closes #456\", \"Resolves #789\"\n- âœ… Tests pasan + archivo especÃ­fico mencionado en issue modificado\n- âœ… Issue marcado como \"auto-close\" en labels\n\n### **Cierre Sugerido (Con Comentario):**\n- ğŸ¤– Tests ahora pasan + archivos relacionados modificados\n- ğŸ¤– TODOs/FIXMEs removidos del cÃ³digo\n- ğŸ¤– Dependencias actualizadas (para issues de vulnerabilidades)\n\n### **No Cerrar AutomÃ¡ticamente:**\n- âŒ Issues con label \"manual-review\"\n- âŒ Issues asignados a otras personas\n- âŒ Issues con milestone futuro\n- âŒ Tests aÃºn fallando\n\n## ğŸ¯ **Flujo Completo:**\n\n```\n1. Commit realizado â†’ Hook se activa\n2. Analizar mensaje del commit â†’ Buscar referencias a issues\n3. Verificar estado de tests â†’ Determinar si problemas resueltos\n4. Buscar issues relacionados â†’ Por archivos modificados\n5. Aplicar reglas de cierre â†’ AutomÃ¡tico o sugerido\n6. Actualizar issues â†’ Cerrar o comentar\n7. Notificar resultados â†’ Resumen de acciones\n```\n\n## ğŸ“‹ **Reporte de Acciones:**\n\nAl final del proceso, generar reporte:\n\n```\nğŸ“Š **Issue Auto Closer Report**\n\nâœ… **Issues Cerrados AutomÃ¡ticamente:**\n- #123: Fix TypeScript errors in JWT Service\n- #456: Resolve database connection issues\n\nğŸ¤– **Issues con Sugerencia de Cierre:**\n- #789: Performance optimization (comentario agregado)\n- #101: Update dependencies (comentario agregado)\n\nâ³ **Issues Sin Cambios:**\n- #202: Manual review required\n- #303: Assigned to other developer\n\nğŸ“ˆ **EstadÃ­sticas:**\n- Issues procesados: 6\n- Cerrados automÃ¡ticamente: 2\n- Sugerencias agregadas: 2\n- Sin cambios: 2\n```\n\n**Â¿Proceder con el anÃ¡lisis automÃ¡tico del commit y cierre de issues relacionados?**"
  }
}
