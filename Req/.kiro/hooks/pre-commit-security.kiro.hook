{
  "enabled": true,
  "name": "Pre-commit Security Scanner",
  "description": "Escanea commits en busca de secrets, API keys y errores de sintaxis antes de commit",
  "version": "1.0",
  "when": {
    "type": "beforeCommit",
    "patterns": [
      "**/*"
    ]
  },
  "then": {
    "type": "askAgent",
    "prompt": "ğŸ”’ **Pre-commit Security Scanner Activado**\n\nVoy a escanear el commit en busca de:\n\n## ğŸ” **Verificaciones de Seguridad:**\n\n### **1. DetecciÃ³n de Secrets/API Keys**\n```bash\n# Buscar patrones de API keys comunes\necho \"ğŸ” Escaneando secrets...\"\n\n# Patrones de API keys a detectar\nPATTERNS=(\n  \"gsk_[A-Za-z0-9]{48}\"     # Groq API Key\n  \"AIza[A-Za-z0-9]{35}\"     # Google API Key\n  \"hf_[A-Za-z0-9]{37}\"      # HuggingFace Token\n  \"ghp_[A-Za-z0-9]{36}\"     # GitHub Personal Access Token\n  \"[0-9]{10}:[A-Za-z0-9_-]{35}\" # Telegram Bot Token\n  \"sk-[A-Za-z0-9]{48}\"      # OpenAI API Key\n)\n\n# Escanear archivos staged\nfor pattern in \"${PATTERNS[@]}\"; do\n  if git diff --cached --name-only | xargs grep -l \"$pattern\" 2>/dev/null; then\n    echo \"âŒ PELIGRO: API Key detectada con patrÃ³n: $pattern\"\n    echo \"ğŸš« COMMIT BLOQUEADO por seguridad\"\n    exit 1\n  fi\ndone\n\necho \"âœ… No se detectaron secrets hardcodeados\"\n```\n\n### **2. ValidaciÃ³n de Sintaxis YAML**\n```bash\necho \"ğŸ“ Validando archivos YAML...\"\n\n# Encontrar archivos YAML en el commit\nYAML_FILES=$(git diff --cached --name-only | grep -E '\\.(yml|yaml)$' || true)\n\nif [ -n \"$YAML_FILES\" ]; then\n  for file in $YAML_FILES; do\n    echo \"ğŸ” Validando: $file\"\n    \n    # Verificar sintaxis YAML bÃ¡sica\n    if ! python3 -c \"import yaml; yaml.safe_load(open('$file'))\" 2>/dev/null; then\n      echo \"âŒ ERROR: Sintaxis YAML invÃ¡lida en $file\"\n      echo \"ğŸš« COMMIT BLOQUEADO por sintaxis incorrecta\"\n      exit 1\n    fi\n    \n    # Verificaciones especÃ­ficas para GitHub Actions\n    if [[ $file == *\"workflows\"* ]]; then\n      echo \"ğŸ” Validando GitHub Action: $file\"\n      \n      # Verificar estructura bÃ¡sica de GitHub Actions\n      if ! grep -q \"^name:\" \"$file\"; then\n        echo \"âŒ ERROR: Falta campo 'name' en GitHub Action\"\n        exit 1\n      fi\n      \n      if ! grep -q \"^on:\" \"$file\"; then\n        echo \"âŒ ERROR: Falta campo 'on' en GitHub Action\"\n        exit 1\n      fi\n      \n      if ! grep -q \"^jobs:\" \"$file\"; then\n        echo \"âŒ ERROR: Falta campo 'jobs' en GitHub Action\"\n        exit 1\n      fi\n      \n      # Verificar que no haya secrets hardcodeados en workflows\n      if grep -E \"(gsk_|AIza|hf_|ghp_|sk-)\" \"$file\"; then\n        echo \"âŒ ERROR: Secret hardcodeado detectado en workflow\"\n        echo \"ğŸ’¡ Usa \\${{ secrets.SECRET_NAME }} en su lugar\"\n        exit 1\n      fi\n    fi\n    \n    echo \"âœ… $file es vÃ¡lido\"\n  done\nelse\n  echo \"â„¹ï¸ No hay archivos YAML para validar\"\nfi\n```\n\n### **3. VerificaciÃ³n de Variables de Entorno**\n```bash\necho \"ğŸ”§ Verificando variables de entorno...\"\n\n# Verificar que archivos .env no estÃ©n siendo commiteados\nif git diff --cached --name-only | grep -E '\\.env$|\\.env\\.' | grep -v '\\.env\\.example'; then\n  echo \"âŒ ERROR: Archivo .env detectado en commit\"\n  echo \"ğŸš« Los archivos .env no deben ser commiteados\"\n  echo \"ğŸ’¡ Agrega .env a .gitignore\"\n  exit 1\nfi\n\necho \"âœ… No se detectaron archivos .env en el commit\"\n```\n\n### **4. VerificaciÃ³n de Archivos de ConfiguraciÃ³n**\n```bash\necho \"âš™ï¸ Verificando archivos de configuraciÃ³n...\"\n\n# Verificar package.json si estÃ¡ siendo modificado\nif git diff --cached --name-only | grep -q \"package.json\"; then\n  echo \"ğŸ” Validando package.json...\"\n  if ! python3 -c \"import json; json.load(open('package.json'))\" 2>/dev/null; then\n    echo \"âŒ ERROR: package.json tiene sintaxis JSON invÃ¡lida\"\n    exit 1\n  fi\n  echo \"âœ… package.json es vÃ¡lido\"\nfi\n\n# Verificar archivos TypeScript config\nfor tsconfig in $(git diff --cached --name-only | grep \"tsconfig.*\\.json\"); do\n  echo \"ğŸ” Validando: $tsconfig\"\n  if ! python3 -c \"import json; json.load(open('$tsconfig'))\" 2>/dev/null; then\n    echo \"âŒ ERROR: $tsconfig tiene sintaxis JSON invÃ¡lida\"\n    exit 1\n  fi\n  echo \"âœ… $tsconfig es vÃ¡lido\"\ndone\n```\n\n### **5. Reporte Final**\n```bash\necho \"\"\necho \"ğŸ‰ **Pre-commit Security Scan Completado**\"\necho \"âœ… Todos los archivos pasaron las verificaciones de seguridad\"\necho \"âœ… Sintaxis YAML/JSON vÃ¡lida\"\necho \"âœ… No se detectaron secrets hardcodeados\"\necho \"âœ… Variables de entorno seguras\"\necho \"\"\necho \"ğŸš€ Commit aprobado para continuar\"\n```\n\n## ğŸ›¡ï¸ **Protecciones Implementadas:**\n\n- âœ… DetecciÃ³n de API keys hardcodeadas\n- âœ… ValidaciÃ³n de sintaxis YAML/JSON\n- âœ… VerificaciÃ³n de GitHub Actions\n- âœ… ProtecciÃ³n de archivos .env\n- âœ… ValidaciÃ³n de archivos de configuraciÃ³n\n\n**Â¿Quieres que ejecute el escaneo de seguridad en el commit actual?**"
  }
}
